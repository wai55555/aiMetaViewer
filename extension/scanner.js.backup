// scanner.js - Phase 2 Optimized: Deduplication, Negative Caching, Batch Processing

// ãƒã‚¬ãƒ†ã‚£ãƒ–ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã‹ã£ãŸURLã‚’è¨˜æ†¶ï¼‰
const noMetadataCache = new Set();
// ãƒã‚¸ãƒ†ã‚£ãƒ–ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ content.js ã® metadataCache ã‚’ä½¿ç”¨ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ã¯ãªã„ãŸã‚ã€ã“ã“ã§ã‚‚æŒã¤ã‹ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸çµŒç”±ã«ã™ã‚‹ï¼‰
// content.jsã®metadataCacheã¯exportã•ã‚Œã¦ã„ãªã„ã®ã§ã€scanner.jså†…ã§ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æŒã¤å¿…è¦ãŒã‚ã‚‹ã€‚
// ãŸã ã—ã€processedImagesã«ã‚ã‚‹ã‚‚ã®ã¯æ—¢ã«ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã€‚
const localMetadataCache = new Map();

async function scanAllImages() {
    // æœ€æ–°ã®è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰
    const settings = typeof loadSettings !== 'undefined' ? await loadSettings() : window.settings;
    console.log('[AI Meta Viewer] Starting optimized full page scan (Phase 2)...', settings);

    // 1. ç”»åƒåé›†ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const allImages = Array.from(document.querySelectorAll('img'));
    let filteredCount = 0;
    const images = allImages.filter(img => {
        // ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã§è§£æ±ºã‚’è©¦ã¿ã‚‹
        const resolved = typeof resolveOriginalUrls === 'function' ? resolveOriginalUrls(img) : null;
        const resolvedUrls = Array.isArray(resolved) ? resolved : (resolved ? [resolved] : []);

        // ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ã€Œåˆ¥ã®URLã€ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã¯ã€ã‚µãƒ ãƒã‚¤ãƒ«ã®å¯èƒ½æ€§ãŒé«˜ã„ã®ã§è¨±å¯
        const hasNewResolution = resolvedUrls.some(u => u !== img.src && u !== img.currentSrc);
        if (hasNewResolution) return true;

        const width = img.naturalWidth || img.width || 0;
        const height = img.naturalHeight || img.height || 0;

        // ã‚µã‚¤ã‚ºãŒ0ã®å ´åˆã¯ã€ã¾ã ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„ã‹éš ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€
        // å¿µã®ãŸã‚ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡ã«å«ã‚ã‚‹ (ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®å‰¯ä½œç”¨ã‚’é˜²ã)
        if (width === 0 || height === 0) return true;

        // æ•°å€¤ã¨ã—ã¦æ¯”è¼ƒã™ã‚‹ã“ã¨ã‚’ä¿è¨¼
        const minPixels = Number(settings.minPixelCount) || 0;
        const minSize = Number(settings.minImageSize) || 0;

        // æœ€å°ç”»ç´ æ•°ãƒã‚§ãƒƒã‚¯
        if (width * height < minPixels) {
            filteredCount++;
            return false;
        }

        // æœ€å°ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ (å¹…ã¾ãŸã¯é«˜ã•ã®ä¸€æ–¹ãŒè¦å®šæœªæº€ãªã‚‰é™¤å¤–)
        if (width < minSize || height < minSize) {
            filteredCount++;
            return false;
        }

        return true;
    });

    console.log(`[AI Meta Viewer] Found ${allImages.length} images, ${images.length} kept, ${filteredCount} filtered out by size settings.`);

    const totalImages = images.length;

    const viewportHeight = window.innerHeight;
    images.sort((a, b) => {
        const rectA = a.getBoundingClientRect();
        const rectB = b.getBoundingClientRect();

        const visibleA = rectA.top < viewportHeight && rectA.bottom > 0;
        const visibleB = rectB.top < viewportHeight && rectB.bottom > 0;

        if (visibleA && !visibleB) return -1;
        if (!visibleA && visibleB) return 1;

        return rectA.top - rectB.top;
    });

    let processedCount = 0;
    let foundCount = 0;
    let isCancelled = false;
    let uniqueFetchCount = 0;

    const overlayData = showScanningOverlay(totalImages);
    const { overlay, updateProgress, cancelButton } = overlayData;

    cancelButton.onclick = () => {
        isCancelled = true;
        overlay.remove();
        console.log('[AI Meta Viewer] Scan cancelled by user.');
    };

    try {
        const candidates = [];
        const candidateUrls = new Set(); // é‡è¤‡URLé˜²æ­¢ç”¨

        // 2. URLè§£æ±ºã¨ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        // Map<OriginalURL, Array<HTMLImageElement>>
        const urlToImagesMap = new Map();
        // Set<HTMLImageElement> (URLè§£æ±ºã«å¤±æ•—ã—ãŸã‹ã€ã‚¹ã‚­ãƒƒãƒ—å¯¾è±¡ã®ç”»åƒ)
        const skippedImages = new Set();

        for (const img of images) {
            // æ—¢ã«å‡¦ç†æ¸ˆã¿ã®ç”»åƒã¯ã‚¹ã‚­ãƒƒãƒ—
            if (typeof processedImages !== 'undefined' && processedImages.has(img)) {
                const data = processedImages.get(img);
                if (data && data.badge) {
                    candidates.push({
                        type: 'image',
                        url: data.badge._originalUrl || img.src,
                        thumbnailUrl: img.src, // Use current image src as thumbnail
                        filename: getFilenameFromUrl(data.badge._originalUrl || img.src),
                        metadata: data.badge._metadata || null,
                        isAI: !!(data.badge._metadata && Object.keys(data.badge._metadata).length > 0)
                    });
                    processedCount++;
                    if (candidates[candidates.length - 1].isAI) foundCount++;
                    updateProgress(processedCount, foundCount);
                    continue;
                }
            }

            const urls = resolveOriginalUrls(img);
            if (urls) {
                // è¤‡æ•°ã®å€™è£œãŒã‚ã‚‹å ´åˆã€å…¨ã¦ã‚’è©¦ã™å¿…è¦ãŒã‚ã‚‹ãŒã€
                // ã“ã“ã§ã¯å˜ç´”åŒ–ã®ãŸã‚ã€é…åˆ—ã®å ´åˆã¯ä¸»è¦ãªURLã ã‘ã‚’ã‚­ãƒ¼ã«ã™ã‚‹ã‹ã€
                // æ§‹æˆã‚’å·¥å¤«ã™ã‚‹ã€‚resolveOriginalUrlsã¯é…åˆ—ã‚’è¿”ã™ã“ã¨ãŒã‚ã‚‹ã€‚
                const urlArray = Array.isArray(urls) ? urls : [urls];

                // ç”»åƒã”ã¨ã«ã©ã®URLã‚’è©¦ã™ã¹ãã‹ã‚’ä¿æŒ
                // URLå˜ä½ã§ãƒ•ã‚§ãƒƒãƒã™ã‚‹ãŸã‚ã€é€†å¼•ããƒãƒƒãƒ—ã‚’ä½œã‚‹
                for (const url of urlArray) {
                    if (!urlToImagesMap.has(url)) {
                        urlToImagesMap.set(url, []);
                    }
                    urlToImagesMap.get(url).push(img);
                }
            } else {
                // ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã§è§£æ±ºã§ããªã„å ´åˆã€img.srcã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨
                const src = img.src || img.currentSrc;
                if (src && src.startsWith('http')) {
                    if (!urlToImagesMap.has(src)) {
                        urlToImagesMap.set(src, []);
                    }
                    urlToImagesMap.get(src).push(img);
                } else {
                    skippedImages.add(img);
                    processedCount++;
                    updateProgress(processedCount, foundCount);
                }
            }
        }

        // 3. ãƒ•ã‚§ãƒƒãƒå¯¾è±¡ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯URLãƒªã‚¹ãƒˆã‚’ä½œæˆ
        const uniqueUrls = Array.from(urlToImagesMap.keys());

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã®çµæœã‚’æ ¼ç´ã™ã‚‹ãƒãƒƒãƒ—
        const fetchResults = new Map(); // URL -> Metadata | null

        const urlsToFetch = uniqueUrls.filter(url => {
            const associatedImages = urlToImagesMap.get(url) || [];
            if (noMetadataCache.has(url)) {
                fetchResults.set(url, null);
                // ãƒã‚¬ãƒ†ã‚£ãƒ–ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ: é€²æ—æ›´æ–°
                processedCount += associatedImages.length;
                updateProgress(processedCount, foundCount);
                return false;
            }
            if (localMetadataCache.has(url)) {
                const meta = localMetadataCache.get(url);
                fetchResults.set(url, meta);
                // ãƒã‚¸ãƒ†ã‚£ãƒ–ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ: é€²æ—æ›´æ–°
                processedCount += associatedImages.length;
                if (meta && Object.keys(meta).length > 0) {
                    foundCount += associatedImages.length;
                }
                updateProgress(processedCount, foundCount);
                return false;
            }
            return true;
        });

        console.log(`[AI Meta Viewer] Unique URLs to fetch: ${urlsToFetch.length} (Total images: ${images.length})`);

        // 4. ãƒãƒƒãƒå‡¦ç†ã§ãƒ•ã‚§ãƒƒãƒå®Ÿè¡Œ
        const CONCURRENCY_LIMIT = 8; // é‡è¤‡æ’é™¤ã—ãŸã®ã§å°‘ã—å¢—ã‚„ã™

        const queue = [...urlsToFetch];

        async function worker() {
            while (queue.length > 0 && !isCancelled) {
                const url = queue.shift();
                uniqueFetchCount++;

                try {
                    const response = await chrome.runtime.sendMessage({
                        action: 'fetchImageMetadata',
                        imageUrl: url
                    });

                    if (response && response.success && response.metadata && Object.keys(response.metadata).length > 0) {
                        localMetadataCache.set(url, response.metadata);
                        fetchResults.set(url, response.metadata);
                    } else {
                        noMetadataCache.add(url);
                        fetchResults.set(url, null);
                    }
                } catch (e) {
                    console.error('[AI Meta Viewer] Error fetching URL:', url, e);
                    noMetadataCache.add(url); // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚ä¸€æ—¦è¨˜éŒ²ã—ã¦ãŠã
                    fetchResults.set(url, null);
                }

                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–° (Batch Processing)
                const relatedImages = urlToImagesMap.get(url) || [];
                processedCount += relatedImages.length;

                // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆï¼ˆã¾ãŸã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚»ãƒƒãƒˆã•ã‚ŒãŸå ´åˆï¼‰ã€é–¢é€£ç”»åƒã™ã¹ã¦ãŒã€ŒAIåˆ¤å®šã€ã¨ãªã‚‹
                // ã“ã“ã§ã®åˆ¤å®šã¯ç°¡æ˜“çš„ã€‚æ­£ç¢ºã«ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ä¸­èº«ã‚’è¦‹ã‚‹ã€‚
                const resMeta = fetchResults.get(url);
                if (resMeta && Object.keys(resMeta).length > 0) {
                    foundCount += relatedImages.length;
                }
                updateProgress(processedCount, foundCount);
            }
        }

        const workers = Array(Math.min(CONCURRENCY_LIMIT, queue.length))
            .fill(null)
            .map(() => worker());

        await Promise.all(workers);

        if (isCancelled) return;

        // 5. çµæœã®é©ç”¨ã¨å€™è£œãƒªã‚¹ãƒˆä½œæˆ
        // å„ç”»åƒã«ã¤ã„ã¦ã€è‡ªåˆ†ã«é–¢é€£ã™ã‚‹URLã®çµæœã‚’ç¢ºèªã—ã¦æ¡ç”¨

        // ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸç”»åƒä»¥å¤–ã®å‡¦ç†å¯¾è±¡ç”»åƒ
        const imagesToResolve = images.filter(img => !skippedImages.has(img) && !(typeof processedImages !== 'undefined' && processedImages.has(img)));

        for (const img of imagesToResolve) {
            const urls = resolveOriginalUrls(img);
            const urlArray = Array.isArray(urls) ? urls : [urls];

            let bestMetadata = null;
            let bestUrl = urlArray[0];

            for (const url of urlArray) {
                const res = fetchResults.get(url);
                if (res) {
                    bestMetadata = res;
                    bestUrl = url;
                    break;
                }
            }

            if (bestMetadata) {
                if (!candidateUrls.has(bestUrl)) {
                    candidates.push({
                        type: 'image',
                        url: bestUrl,
                        thumbnailUrl: img.src,
                        filename: getFilenameFromUrl(bestUrl),
                        metadata: bestMetadata,
                        width: img.naturalWidth || img.width || 0,
                        height: img.naturalHeight || img.height || 0,
                        isAI: true
                    });
                    candidateUrls.add(bestUrl);
                }
            } else {
                // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãªã—
                if (!candidateUrls.has(bestUrl)) {
                    candidates.push({
                        type: 'image',
                        url: bestUrl,
                        thumbnailUrl: img.src,
                        filename: getFilenameFromUrl(bestUrl),
                        metadata: null,
                        width: img.naturalWidth || img.width || 0,
                        height: img.naturalHeight || img.height || 0,
                        isAI: false
                    });
                    candidateUrls.add(bestUrl);
                }
            }

            // processedCount++; // Workerå´ã§ã‚«ã‚¦ãƒ³ãƒˆæ¸ˆã¿ã®ãŸã‚ã“ã“ã§ã¯é™¤å»
            // updateProgress(processedCount, foundCount);
        }

        console.log('[AI Meta Viewer] Scan complete. Found images:', candidates.length, 'AI:', foundCount, 'Unique Fetches:', uniqueFetchCount);

        // --- ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¹ã‚­ãƒ£ãƒ³ (SiteAdapters çµŒç”±) ---
        console.log('[AI Meta Viewer] Performing deep scan...');
        if (typeof SiteAdapters !== 'undefined') {
            for (const adapter of SiteAdapters) {
                if (adapter.match() && typeof adapter.deepScan === 'function') {
                    const deepCandidates = adapter.deepScan(document);
                    if (deepCandidates && Array.isArray(deepCandidates)) {
                        console.log(`[AI Meta Viewer] Deep scan found ${deepCandidates.length} candidates from ${adapter.match.toString()}`);
                        for (const dc of deepCandidates) {
                            if (!candidateUrls.has(dc.url)) {
                                candidates.push({
                                    type: dc.type || 'image',
                                    url: dc.url,
                                    thumbnailUrl: dc.thumbnailUrl || null,
                                    filename: dc.filename || getFilenameFromUrl(dc.url),
                                    metadata: dc.metadata || null,
                                    isAI: dc.isAI !== undefined ? dc.isAI : false,
                                    autoSelect: dc.autoSelect, // Civitaiç­‰ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‹ã‚‰æ˜ç¤ºçš„ãªé¸æŠæŒ‡ç¤ºã‚’å—ã‘å–ã‚‹
                                    isCivitaiModel: dc.isCivitaiModel, // Civitaiç‰¹æ®Šãƒ•ãƒ©ã‚°
                                    modelName: dc.modelName, // ZIPåŒ–ç”¨
                                    width: dc.width || 0,
                                    height: dc.height || 0
                                });
                                candidateUrls.add(dc.url);
                                if (dc.isAI) foundCount++; // æ·±å±¤ã‚¹ã‚­ãƒ£ãƒ³ã§è¦‹ã¤ã‹ã£ãŸAIåˆ¤å®šã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                            }
                        }
                    }
                }
            }
        }

        // æœ€çµ‚çš„ãªæ•´åˆæ€§ã®ãŸã‚ã«ä¸€å›æ›´æ–°
        updateProgress(totalImages, foundCount);

        // --- å‹•ç”»ãƒ»éŸ³å£°ãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®æ¤œå‡º ---
        console.log('[AI Meta Viewer] Scanning for other media types...');

        // å‹•ç”»è¦ç´ ã®æ¤œå‡º
        const videos = Array.from(document.querySelectorAll('video'));
        for (const video of videos) {
            const src = video.src || video.currentSrc;
            if (!src) continue;

            // ã™ã§ã«ç”»åƒã¨ã—ã¦ã€ã‚ã‚‹ã„ã¯åˆ¥ã®è¦ç´ ã§è¿½åŠ æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
            if (candidateUrls.has(src)) continue;

            // ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’æ¤œå‡º
            let thumbnailUrl = video.poster || null;

            // posterå±æ€§ãŒãªã„å ´åˆã€å‘¨è¾ºã®ç”»åƒè¦ç´ ã‹ã‚‰ã‚µãƒ ãƒã‚¤ãƒ«ã‚’æ¢ã™
            if (!thumbnailUrl) {
                thumbnailUrl = findVideoThumbnail(video);
            }

            candidates.push({
                type: 'video',
                url: src,
                thumbnailUrl: thumbnailUrl,
                filename: getFilenameFromUrl(src),
                metadata: null,
                isAI: false
            });
            candidateUrls.add(src);
        }

        // éŸ³å£°è¦ç´ ã®æ¤œå‡º
        const audios = Array.from(document.querySelectorAll('audio'));
        for (const audio of audios) {
            const src = audio.src || audio.currentSrc;
            if (!src) continue;

            // ã™ã§ã«ç”»åƒ/å‹•ç”»ã¨ã—ã¦è¿½åŠ æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
            if (candidateUrls.has(src)) continue;

            candidates.push({
                type: 'audio',
                url: src,
                thumbnailUrl: null,
                filename: getFilenameFromUrl(src),
                metadata: null,
                isAI: false
            });
            candidateUrls.add(src);
        }

        // ãƒªãƒ³ã‚¯ã‹ã‚‰å‹•ç”»ãƒ»éŸ³å£°ãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’æ¤œå‡º
        const links = Array.from(document.querySelectorAll('a[href]'));
        const mediaLinks = links.filter(a => {
            const href = a.href.toLowerCase();
            // è¤‡åˆæ‹¡å¼µå­å¯¾å¿œ: tar.gz, tar.bz2, tar.xz ãªã©
            // ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ: .safetensors, .ckpt, .pt
            return /\.(mp4|webm|mkv|avi|flv|mov|mp3|wav|ogg|m4a|flac|zip|rar|7z|lzh|tar|tar\.gz|tar\.bz2|tar\.xz|tgz|tbz2|safetensors|ckpt|pt)$/i.test(href);
        });

        for (const link of mediaLinks) {
            const href = link.href;
            const filename = getFilenameFromUrl(href);
            const type = getMediaType(filename);

            // ã™ã§ã«ä»–ã®è¦ç´ ï¼ˆvideo/audioã‚¿ã‚°ç­‰ï¼‰ã§è¿½åŠ æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
            if (candidateUrls.has(href)) continue;

            // å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã€ãƒªãƒ³ã‚¯å‘¨è¾ºã®ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’æ¤œå‡º
            let thumbnailUrl = null;
            if (type === 'video') {
                thumbnailUrl = findLinkThumbnail(link);
            }

            candidates.push({
                type: type,
                url: href,
                thumbnailUrl: thumbnailUrl,
                filename: filename,
                metadata: null,
                isAI: false
            });
            candidateUrls.add(href);
        }

        console.log('[AI Meta Viewer] Total media found:', candidates.length,
            'Videos:', candidates.filter(c => c.type === 'video').length,
            'Audio:', candidates.filter(c => c.type === 'audio').length,
            'Archives:', candidates.filter(c => c.type === 'archive').length);

        if (candidates.length > 0) {
            const context = {
                pageTitle: document.title,
                domain: window.location.hostname
            };
            const modal = createDownloaderModal(candidates, context);
            document.body.appendChild(modal);
        } else {
            showNotification('No media suitable for download found on this page.');
        }

    } finally {
        if (overlay && overlay.parentNode) overlay.remove();
    }
}

/**
 * å‹•ç”»è¦ç´ ã®å‘¨è¾ºã‹ã‚‰ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’æ¤œå‡º
 * @param {HTMLVideoElement} video - å‹•ç”»è¦ç´ 
 * @returns {string|null} - ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã®URLã€è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯null
 */
function findVideoThumbnail(video) {
    // 1. è¦ªè¦ç´ å†…ã®ç”»åƒã‚’æ¤œç´¢
    let parent = video.parentElement;
    for (let i = 0; i < 3 && parent; i++) { // æœ€å¤§3éšå±¤ã¾ã§é¡ã‚‹
        const images = parent.querySelectorAll('img');
        for (const img of images) {
            if (img !== video && img.src && img.src.startsWith('http')) {
                // å‹•ç”»è¦ç´ ã¨åŒã˜è¦ªã‚’æŒã¤ç”»åƒã‚’ã‚µãƒ ãƒã‚¤ãƒ«ã¨ã—ã¦ä½¿ç”¨
                return img.src;
            }
        }
        parent = parent.parentElement;
    }

    // 2. å…„å¼Ÿè¦ç´ å†…ã®ç”»åƒã‚’æ¤œç´¢
    if (video.parentElement) {
        const siblings = Array.from(video.parentElement.children);
        for (const sibling of siblings) {
            if (sibling !== video && sibling.tagName === 'IMG' && sibling.src) {
                return sibling.src;
            }
            // å…„å¼Ÿè¦ç´ å†…ã®ç”»åƒã‚‚æ¤œç´¢
            const nestedImages = sibling.querySelectorAll('img');
            for (const img of nestedImages) {
                if (img.src && img.src.startsWith('http')) {
                    return img.src;
                }
            }
        }
    }

    // 3. data-thumbnail, data-poster ãªã©ã®å±æ€§ã‚’ãƒã‚§ãƒƒã‚¯
    const thumbnailAttrs = ['data-thumbnail', 'data-poster', 'data-preview', 'data-image'];
    for (const attr of thumbnailAttrs) {
        const value = video.getAttribute(attr);
        if (value && value.startsWith('http')) {
            return value;
        }
    }

    return null;
}

/**
 * ãƒªãƒ³ã‚¯è¦ç´ ã®å‘¨è¾ºã‹ã‚‰ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’æ¤œå‡º
 * @param {HTMLAnchorElement} link - ãƒªãƒ³ã‚¯è¦ç´ 
 * @returns {string|null} - ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã®URLã€è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯null
 */
function findLinkThumbnail(link) {
    // 1. ãƒªãƒ³ã‚¯å†…ã®ç”»åƒã‚’æ¤œç´¢
    const linkImages = link.querySelectorAll('img');
    for (const img of linkImages) {
        if (img.src && img.src.startsWith('http')) {
            return img.src;
        }
    }

    // 2. è¦ªè¦ç´ å†…ã®ç”»åƒã‚’æ¤œç´¢
    let parent = link.parentElement;
    for (let i = 0; i < 3 && parent; i++) { // æœ€å¤§3éšå±¤ã¾ã§é¡ã‚‹
        const images = parent.querySelectorAll('img');
        for (const img of images) {
            if (img.src && img.src.startsWith('http')) {
                // ãƒªãƒ³ã‚¯ã¨è¿‘ã„ä½ç½®ã«ã‚ã‚‹ç”»åƒã‚’ã‚µãƒ ãƒã‚¤ãƒ«ã¨ã—ã¦ä½¿ç”¨
                return img.src;
            }
        }
        parent = parent.parentElement;
    }

    // 3. å…„å¼Ÿè¦ç´ å†…ã®ç”»åƒã‚’æ¤œç´¢
    if (link.parentElement) {
        const siblings = Array.from(link.parentElement.children);
        for (const sibling of siblings) {
            if (sibling !== link) {
                if (sibling.tagName === 'IMG' && sibling.src) {
                    return sibling.src;
                }
                // å…„å¼Ÿè¦ç´ å†…ã®ç”»åƒã‚‚æ¤œç´¢
                const nestedImages = sibling.querySelectorAll('img');
                for (const img of nestedImages) {
                    if (img.src && img.src.startsWith('http')) {
                        return img.src;
                    }
                }
            }
        }
    }

    // 4. dataå±æ€§ã‚’ãƒã‚§ãƒƒã‚¯
    const thumbnailAttrs = ['data-thumbnail', 'data-poster', 'data-preview', 'data-image'];
    for (const attr of thumbnailAttrs) {
        const value = link.getAttribute(attr);
        if (value && value.startsWith('http')) {
            return value;
        }
    }

    return null;
}

/**
 * è‡ªå‹•çš„ã«æ¶ˆãˆã‚‹é€šçŸ¥ã‚’è¡¨ç¤º
 * @param {string} message - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 * @param {number} duration - è¡¨ç¤ºæ™‚é–“(ãƒŸãƒªç§’)ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3ç§’
 */
function showNotification(message, duration = 3000) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(30, 30, 30, 0.95);
        color: white;
        padding: 12px 20px;
        border-radius: 12px;
        z-index: 2147483647;
        font-family: 'Segoe UI', sans-serif;
        font-size: 14px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(8px);
        min-width: 240px;
        text-align: center;
        animation: ai-meta-fade-in 0.3s ease-out;
    `;
    notification.textContent = message;

    document.body.appendChild(notification);

    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«å‰Šé™¤
    setTimeout(() => {
        notification.style.animation = 'ai-meta-fade-out 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, duration);
}

/**
 * ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
 */
function showScanningOverlay(total) {
    const overlay = document.createElement('div');
    overlay.className = 'ai-meta-scan-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(30, 30, 30, 0.95);
        color: white;
        padding: 12px 20px;
        border-radius: 12px;
        z-index: 2147483647;
        font-family: 'Segoe UI', sans-serif;
        font-size: 14px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(8px);
        min-width: 240px;
    `;

    overlay.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.2); border-top-color: #4CAF50; border-radius: 50%; animation: ai-meta-spin 0.8s linear infinite;"></div>
                <span style="font-weight: 600; letter-spacing: 0.3px;">Scanning AI Images</span>
            </div>
            <button id="ai-meta-scan-cancel" style="background: rgba(255,255,255,0.1); border: none; color: #ffab91; font-size: 11px; padding: 4px 8px; border-radius: 4px; cursor: pointer; transition: background 0.2s;">Cancel</button>
        </div>
        <div style="height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;">
            <div id="ai-meta-scan-progress-bar" style="width: 0%; height: 100%; background: #4CAF50; transition: width 0.3s ease;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #aaa;">
            <span id="ai-meta-scan-count">Progress: 0 / ${total}</span>
            <span id="ai-meta-scan-found" style="color: #81C784;">Found: 0</span>
        </div>
    `;

    // ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    const cancelButton = overlay.querySelector('#ai-meta-scan-cancel');
    cancelButton.onmouseover = () => cancelButton.style.background = 'rgba(255,255,255,0.2)';
    cancelButton.onmouseout = () => cancelButton.style.background = 'rgba(255,255,255,0.1)';

    const progressBar = overlay.querySelector('#ai-meta-scan-progress-bar');
    const countText = overlay.querySelector('#ai-meta-scan-count');
    const foundText = overlay.querySelector('#ai-meta-scan-found');

    const updateProgress = (current, found) => {
        const percent = Math.round((current / total) * 100);
        progressBar.style.width = `${percent}%`;
        countText.textContent = `Progress: ${current} / ${total}`;
        foundText.textContent = `Found: ${found}`;
    };

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ ï¼ˆåˆå›ã®ã¿ï¼‰
    if (!document.getElementById('ai-meta-scan-styles')) {
        const style = document.createElement('style');
        style.id = 'ai-meta-scan-styles';
        style.textContent = `
            @keyframes ai-meta-spin {
                to { transform: rotate(360deg); }
            }
            @keyframes ai-meta-fade-in {
                from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
                to { opacity: 1; transform: translateX(-50%) translateY(0); }
            }
            @keyframes ai-meta-fade-out {
                from { opacity: 1; transform: translateX(-50%) translateY(0); }
                to { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            }
        `;
        document.head.appendChild(style);
    }

    document.body.appendChild(overlay);
    return { overlay, updateProgress, cancelButton };
}

/**
 * URLã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ¨æ¸¬
 */
function getFilenameFromUrl(urlStr) {
    try {
        const url = new URL(urlStr);
        const path = url.pathname;
        const parts = path.split('/');
        const lastPart = parts[parts.length - 1];
        if (lastPart && lastPart.includes('.')) {
            return lastPart;
        }
    } catch (e) { }
    return `image_${Date.now()}.png`;
}

/**
 * ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒªã‚¸ãƒŠãƒ«URLã‚’è§£æ±º
 * content.js ã® SiteAdapters ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æµç”¨ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§å¯èƒ½ãªæƒ³å®šï¼‰
 */
function resolveOriginalUrls(img) {
    if (typeof SiteAdapters === 'undefined') return null;

    for (const adapter of SiteAdapters) {
        if (adapter.match()) {
            return adapter.resolve(img);
        }
    }
    return null;
}

// Backgroundã‹ã‚‰ã®ãƒˆãƒªã‚¬ãƒ¼å¾…æ©Ÿ
// ãƒˆãƒƒãƒ—ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã®ã¿ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ(iframeã§ã®é‡è¤‡å®Ÿè¡Œã‚’é˜²æ­¢)
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    if (request.action === 'triggerScan') {
        if (window.self === window.top) {
            scanAllImages();
            sendResponse({ success: true });
        } else {
            // iframeã§ã¯ä½•ã‚‚ã—ãªã„
            sendResponse({ success: false, reason: 'iframe' });
        }
    }

    if (request.action === 'clearMemoryCaches') {
        // scanner.js ã®ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
        const noMetadataCacheSize = noMetadataCache.size;
        const localMetadataCacheSize = localMetadataCache.size;

        noMetadataCache.clear();
        localMetadataCache.clear();

        console.log(`[AI Meta Viewer] Scanner caches cleared: noMetadataCache=${noMetadataCacheSize}, localMetadataCache=${localMetadataCacheSize}`);
        sendResponse({
            success: true,
            clearedItems: {
                noMetadataCache: noMetadataCacheSize,
                localMetadataCache: localMetadataCacheSize
            }
        });
        return true;
    }

    if (request.action === 'showNotification') {
        showNotification(request.message, 5000);
        sendResponse({ success: true });
    }
});

/**
 * ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
 */
function createDownloaderModal(candidates, context) {
    const modalOverlay = document.createElement('div');
    modalOverlay.id = 'ai-meta-downloader-overlay';
    modalOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 2147483647;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: 'Segoe UI', system-ui, sans-serif;
    `;

    // å€™è£œãƒªã‚¹ãƒˆã‹ã‚‰åˆæœŸé¸æŠçŠ¶æ…‹ï¼ˆAIç”»åƒã¾ãŸã¯autoSelectãƒ•ãƒ©ã‚°ï¼‰
    // candidates: [{ type, url, filename, metadata, isAI, autoSelect }]
    let selectedUrls = new Set();
    candidates.forEach(c => {
        // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼ˆsafetensorsç­‰ï¼‰ã¯autoSelectãƒ•ãƒ©ã‚°ã®ã¿ã‚’ä¿¡é ¼ã—ã€isAIãƒ•ãƒ©ã‚°ã¯ç„¡è¦–ã™ã‚‹ï¼ˆæ„å›³ã—ãªã„å…¨é¸æŠé˜²æ­¢ï¼‰
        if (c.type === 'archive') {
            if (c.autoSelect) {
                selectedUrls.add(c.url);
            }
        } else {
            // ç”»åƒç­‰ã¯autoSelectãŒã‚ã‚Œã°å¾“ã„ã€ãªã‘ã‚Œã°isAIã«å¾“ã†
            if (c.autoSelect || (c.isAI && c.autoSelect !== false)) {
                selectedUrls.add(c.url);
            }
        }
    });
    const mediaSizes = new Map(); // URL -> size (bytes)

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®éåŒæœŸå–å¾— (ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’å„ªå…ˆ)
    candidates.forEach(c => {
        if (c.type !== 'image') {
            chrome.runtime.sendMessage({ action: 'getMediaSize', url: c.url }, (res) => {
                if (res && res.success && res.size) {
                    mediaSizes.set(c.url, res.size);
                    renderItems(); // ã‚µã‚¤ã‚ºãŒå–å¾—ã§ããŸã‚‰å†æç”»
                    updateFooter();
                }
            });
        }
    });

    const container = document.createElement('div');
    container.style.cssText = `
        background: #1e1e1e;
        color: #eee;
        width: 800px;
        max-width: 90vw;
        height: 80vh;
        border-radius: 12px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.1);
    `;

    // --- Header ---
    const header = document.createElement('div');
    header.style.cssText = `
        padding: 16px 24px;
        background: #252525;
        border-bottom: 1px solid #333;
        display: flex;
        flex-direction: column;
        gap: 12px;
    `;

    // ã‚¿ã‚¤ãƒˆãƒ«è¡Œ
    const titleRow = document.createElement('div');
    titleRow.style.cssText = `
        display: flex;
        justify-content: space-between;
        align-items: center;
    `;
    titleRow.innerHTML = `
        <div>
            <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Found Media</h2>
            <div id="ai-meta-scan-page-title" style="font-size: 12px; color: #aaa; margin-top: 4px;"></div>
        </div>
        <div style="display: flex; items-align: center; gap: 15px;">
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #aaa;">Total: ${candidates.length}</div>
                <div style="font-size: 12px; color: #4CAF50;">AI: ${candidates.filter(c => c.isAI).length}</div>
            </div>
            <button id="ai-meta-close-btn" style="background: none; border: none; color: #aaa; cursor: pointer; font-size: 24px; padding: 0 8px;">&times;</button>
        </div>
    `;

    // å®‰å…¨ã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
    header.appendChild(titleRow);
    const titleEl = titleRow.querySelector('#ai-meta-scan-page-title');
    if (titleEl) titleEl.textContent = context.pageTitle || 'Unknown Page';

    // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿è¡Œ
    const filterRow = document.createElement('div');
    filterRow.style.cssText = `
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    `;

    const filterBtnStyle = `
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid #444;
        background: #333;
        color: #eee;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
    `;

    const filterBtnActiveStyle = `
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid #4CAF50;
        background: #4CAF50;
        color: white;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s;
    `;

    let activeFilter = 'all';

    const filterButtons = [
        { type: 'all', label: `All (${candidates.length})` },
        { type: 'image', label: `Images (${candidates.filter(c => c.type === 'image').length})` },
        { type: 'video', label: `Videos (${candidates.filter(c => c.type === 'video').length})` },
        { type: 'audio', label: `Audio (${candidates.filter(c => c.type === 'audio').length})` },
        { type: 'archive', label: `Archives (${candidates.filter(c => c.type === 'archive').length})` }
    ];

    filterButtons.forEach(({ type, label }) => {
        const btn = document.createElement('button');
        btn.textContent = label;
        btn.style.cssText = type === 'all' ? filterBtnActiveStyle : filterBtnStyle;
        btn.dataset.type = type;
        btn.onclick = () => {
            activeFilter = type;
            // Update button styles
            filterRow.querySelectorAll('button').forEach(b => {
                b.style.cssText = b.dataset.type === activeFilter ? filterBtnActiveStyle : filterBtnStyle;
            });
            renderItems();
        };
        filterRow.appendChild(btn);
    });

    header.appendChild(filterRow);

    // --- Content (Grid) ---
    const content = document.createElement('div');
    content.style.cssText = `
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 16px;
        background: #1a1a1a;
    `;

    // ç”»åƒã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ
    function renderItems() {
        content.innerHTML = '';

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        const filtered = activeFilter === 'all'
            ? candidates
            : candidates.filter(c => c.type === activeFilter);

        filtered.forEach(c => {
            const isSelected = selectedUrls.has(c.url);
            const item = document.createElement('div');
            item.style.cssText = `
                position: relative;
                border-radius: 8px;
                overflow: hidden;
                background: #2a2a2a;
                border: 2px solid ${isSelected ? '#4CAF50' : 'transparent'};
                cursor: pointer;
                transition: transform 0.1s, border-color 0.1s;
                height: 180px;
                display: flex;
                flex-direction: column;
            `;
            item.onclick = (e) => {
                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯ä¼æ’­ã—ãªã„
                if (e.target.tagName === 'INPUT') return;
                toggleSelection(c.url);
            };

            const imgContainer = document.createElement('div');
            imgContainer.style.cssText = `
                flex: 1;
                background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMCIgaGVpZ2h0PSIxMCI+PHJlY3Qgd2lkdGg9IjUiIGhlaWdodD0iNSIgZmlsbD0iIzMzMyIgLz48cmVjdCB4PSI1IiB5PSI1IiB3aWR0aD0iNSIgaGVpZ2h0PSI1IiBmaWxsPSIjMzMzIiAvPjwvc3ZnPg==');
                position: relative;
                overflow: hidden;
            `;

            // Image or Video Thumbnail
            if (c.type === 'video') {
                // å‹•ç”»ã®å ´åˆã¯ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
                if (c.thumbnailUrl) {
                    // posterå±æ€§ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                    const img = document.createElement('img');
                    img.src = c.thumbnailUrl;
                    img.style.cssText = `
                        width: 100%;
                        height: 100%;
                        object-fit: contain;
                        display: block;
                    `;
                    imgContainer.appendChild(img);
                } else {
                    // posterå±æ€§ãŒãªã„å ´åˆã¯å‹•ç”»ã‹ã‚‰ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
                    generateVideoThumbnail(c.url).then(thumbnailDataUrl => {
                        if (thumbnailDataUrl) {
                            const img = document.createElement('img');
                            img.src = thumbnailDataUrl;
                            img.style.cssText = `
                                width: 100%;
                                height: 100%;
                                object-fit: contain;
                                display: block;
                            `;
                            imgContainer.appendChild(img);
                        } else {
                            // ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆã«å¤±æ•—ã—ãŸå ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
                            const placeholder = document.createElement('div');
                            placeholder.style.cssText = `
                                width: 100%;
                                height: 100%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                background: #333;
                                color: #aaa;
                                font-size: 24px;
                            `;
                            placeholder.textContent = 'ğŸ¬';
                            imgContainer.appendChild(placeholder);
                        }
                    }).catch(() => {
                        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
                        const placeholder = document.createElement('div');
                        placeholder.style.cssText = `
                            width: 100%;
                            height: 100%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            background: #333;
                            color: #aaa;
                            font-size: 24px;
                        `;
                        placeholder.textContent = 'ğŸ¬';
                        imgContainer.appendChild(placeholder);
                    });
                }
            } else {
                // ç”»åƒãƒ»éŸ³å£°ãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®å ´åˆ
                const img = document.createElement('img');
                img.src = c.thumbnailUrl || c.url;
                img.style.cssText = `
                    width: 100%;
                    height: 100%;
                    object-fit: contain;
                    display: block;
                `;

                // ç”»åƒä»¥å¤–ã®å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                if (c.type !== 'image') {
                    img.onerror = () => {
                        const placeholder = document.createElement('div');
                        placeholder.style.cssText = `
                            width: 100%;
                            height: 100%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            background: #333;
                            color: #aaa;
                            font-size: 24px;
                        `;
                        const icons = {
                            audio: 'ğŸµ',
                            archive: 'ğŸ“¦'
                        };
                        placeholder.textContent = icons[c.type] || 'ğŸ“„';
                        imgContainer.replaceChild(placeholder, img);
                    };
                }

                imgContainer.appendChild(img);
            }

            // Badges
            // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—ãƒãƒƒã‚¸ (å‹•ç”»ãƒ»éŸ³å£°ãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–)
            if (c.type !== 'image') {
                const typeBadge = document.createElement('span');
                const typeIcons = {
                    video: 'ğŸ¬',
                    audio: 'ğŸµ',
                    archive: 'ğŸ“¦'
                };
                typeBadge.innerText = typeIcons[c.type] || 'ğŸ“„';
                typeBadge.style.cssText = `
                    position: absolute;
                    top: 6px;
                    right: 6px;
                    background: rgba(0, 0, 0, 0.7);
                    color: white;
                    font-size: 16px;
                    padding: 4px;
                    border-radius: 4px;
                    line-height: 1;
                `;
                imgContainer.appendChild(typeBadge);
            }

            // AIãƒãƒƒã‚¸
            if (c.isAI) {
                const badge = document.createElement('span');
                badge.innerText = 'AI';
                badge.style.cssText = `
                    position: absolute;
                    top: 6px;
                    left: 6px;
                    background: #4CAF50;
                    color: white;
                    font-size: 10px;
                    padding: 2px 6px;
                    border-radius: 4px;
                    font-weight: bold;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.5);
                `;
                imgContainer.appendChild(badge);
            }

            // Info
            const info = document.createElement('div');
            info.style.cssText = `
                padding: 8px;
                font-size: 11px;
                background: #252525;
                color: #ccc;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            `;
            info.innerText = c.filename;
            info.title = c.filename;

            // ã‚µã‚¤ã‚ºè¡¨ç¤º (å–å¾—æ¸ˆã¿ã®å ´åˆ)
            if (mediaSizes.has(c.url)) {
                const size = mediaSizes.get(c.url);
                const sizeStr = formatBytes(size);
                const sizeBadge = document.createElement('div');
                sizeBadge.style.cssText = `
                    font-size: 10px;
                    color: #aaa;
                    margin-top: 2px;
                `;
                sizeBadge.textContent = sizeStr;
                info.appendChild(sizeBadge);
            }

            // Checkbox overlay
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = isSelected;
            checkbox.style.cssText = `
                position: absolute;
                top: 8px;
                right: 8px;
                width: 16px;
                height: 16px;
                accent-color: #4CAF50;
                cursor: pointer;
            `;
            checkbox.onchange = () => toggleSelection(c.url);

            item.appendChild(imgContainer);
            item.appendChild(info);
            item.appendChild(checkbox);
            content.appendChild(item);
        });
    }

    function toggleSelection(url) {
        if (selectedUrls.has(url)) {
            selectedUrls.delete(url);
        } else {
            selectedUrls.add(url);
        }
        updateFooter();
        renderItems();
    }

    // --- Footer ---
    const footer = document.createElement('div');
    footer.style.cssText = `
        padding: 16px 24px;
        background: #252525;
        border-top: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
    `;

    const leftControls = document.createElement('div');
    leftControls.style.display = 'flex';
    leftControls.style.gap = '10px';

    const btnStyle = `
        border: 1px solid #444;
        background: #333;
        color: #eee;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.2s;
    `;

    const selectAllBtn = document.createElement('button');
    selectAllBtn.innerText = 'Select All';
    selectAllBtn.style.cssText = btnStyle;
    selectAllBtn.onclick = () => {
        candidates.forEach(c => selectedUrls.add(c.url));
        updateFooter();
        renderItems();
    };

    const selectAiBtn = document.createElement('button');
    selectAiBtn.innerText = 'Select AI Only';
    selectAiBtn.style.cssText = btnStyle;
    selectAiBtn.onclick = () => {
        selectedUrls.clear();
        candidates.forEach(c => {
            if (c.isAI) selectedUrls.add(c.url);
        });
        updateFooter();
        renderItems();
    };

    const clearBtn = document.createElement('button');
    clearBtn.innerText = 'Clear';
    clearBtn.style.cssText = btnStyle;
    clearBtn.onclick = () => {
        selectedUrls.clear();
        updateFooter();
        renderItems();
    };

    leftControls.appendChild(selectAllBtn);
    leftControls.appendChild(selectAiBtn);
    leftControls.appendChild(clearBtn);

    const downloadBtn = document.createElement('button');
    downloadBtn.style.cssText = `
        background: #4CAF50;
        color: white;
        border: none;
        padding: 8px 24px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    `;

    function updateFooter() {
        const count = selectedUrls.size;
        let totalSizeBytes = 0;
        selectedUrls.forEach(url => {
            totalSizeBytes += (mediaSizes.get(url) || 0);
        });

        const sizeStr = totalSizeBytes > 0 ? ` (${formatBytes(totalSizeBytes)})` : '';
        downloadBtn.innerText = `Download Selected (${count})${sizeStr}`;
        downloadBtn.disabled = count === 0;
        downloadBtn.style.opacity = count === 0 ? '0.5' : '1';
        downloadBtn.style.cursor = count === 0 ? 'not-allowed' : 'pointer';
    }

    downloadBtn.onclick = async () => {
        const count = selectedUrls.size;
        if (count === 0) return;

        // 1GBãƒã‚§ãƒƒã‚¯
        let totalSizeBytes = 0;
        selectedUrls.forEach(url => {
            totalSizeBytes += (mediaSizes.get(url) || 0);
        });

        const ONE_GB = 1024 * 1024 * 1024;
        if (totalSizeBytes > ONE_GB) {
            const confirmed = confirm(`Selected items total ${formatBytes(totalSizeBytes)}, which exceeds 1GB.\nAre you sure you want to start downloading?`);
            if (!confirmed) return;
        }

        const targets = candidates.filter(c => selectedUrls.has(c.url));
        if (targets.length === 0) return;

        const civitaiModel = targets.find(t => t.isCivitaiModel);
        const downloadContext = {
            pageTitle: document.title,
            domain: window.location.hostname,
            isCivitai: !!civitaiModel,
            modelName: civitaiModel?.modelName || 'Civitai_Model'
        };

        downloadBtn.innerText = 'Downloading...';

        try {
            chrome.runtime.sendMessage({
                action: 'downloadImages',
                images: targets,
                context: downloadContext
            }, (response) => {
                if (response && response.success) {
                    showNotification(`Started download for ${response.count} items.`);
                    modalOverlay.remove();
                } else {
                    showNotification('Download failed: ' + (response?.error || 'Unknown error'));
                    updateFooter();
                }
            });
        } catch (e) {
            console.error(e);
            showNotification('Failed to send download message.');
            updateFooter();
        }
    };

    footer.appendChild(leftControls);
    footer.appendChild(downloadBtn);

    // Assemble
    container.appendChild(header);
    container.appendChild(content);
    container.appendChild(footer);
    modalOverlay.appendChild(container);

    // Initial Render
    renderItems();
    updateFooter();

    // Event Handlers
    modalOverlay.querySelector('#ai-meta-close-btn').onclick = () => modalOverlay.remove();
    modalOverlay.onclick = (e) => {
        if (e.target === modalOverlay) modalOverlay.remove();
    };

    return modalOverlay;
}

/**
 * ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®š
 * è¤‡åˆæ‹¡å¼µå­(tar.gzç­‰)ã«ã‚‚å¯¾å¿œ
 * @param {string} filename 
 * @returns {string} 'image' | 'video' | 'audio' | 'archive' | 'unknown'
 */
function getMediaType(filename) {
    const lower = filename.toLowerCase();

    const types = {
        image: ['png', 'jpg', 'jpeg', 'webp', 'avif', 'gif', 'bmp', 'svg'],
        video: ['mp4', 'webm', 'mkv', 'avi', 'flv', 'mov', 'wmv', 'mpg', 'mpeg', 'm4v'],
        audio: ['mp3', 'wav', 'ogg', 'm4a', 'flac', 'aac', 'wma', 'opus'],
        archive: ['zip', 'rar', '7z', 'lzh', 'tar', 'tar.gz', 'tar.bz2', 'tar.xz', 'tgz', 'tbz2', 'gz', 'bz2', 'xz', 'safetensors', 'ckpt', 'pt']
    };

    // è¤‡åˆæ‹¡å¼µå­ã‚’å„ªå…ˆçš„ã«ãƒã‚§ãƒƒã‚¯
    for (const [type, exts] of Object.entries(types)) {
        for (const ext of exts) {
            if (lower.endsWith('.' + ext)) return type;
        }
    }
    return 'unknown';
}

/**
 * ãƒã‚¤ãƒˆæ•°ã‚’èª­ã¿ã‚„ã™ã„å½¢å¼ã«å¤‰æ›
 */
function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}
